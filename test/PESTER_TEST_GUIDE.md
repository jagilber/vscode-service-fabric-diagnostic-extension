# üß™ PowerShell Command Test Suite Guide

Complete Pester test suite for validating Service Fabric PowerShell command generation in the VS Code extension.

---

## üìã Table of Contents

- [Overview](#overview)
- [Prerequisites](#prerequisites)
- [Quick Start](#quick-start)
- [Test Structure](#test-structure)
- [Running Tests](#running-tests)
- [Test Categories](#test-categories)
- [What Gets Tested](#what-gets-tested)
- [CI/CD Integration](#cicd-integration)
- [Troubleshooting](#troubleshooting)

---

## üéØ Overview

This test suite validates that the PowerShell commands and documentation generated by the extension:

‚úÖ Have **valid PowerShell syntax**  
‚úÖ Use **consistent example data** (no PII)  
‚úÖ Include **proper documentation links**  
‚úÖ Follow **PowerShell best practices**  
‚úÖ Provide **safe operation workflows**  
‚úÖ Include **REST API examples**  
‚úÖ Cover **all command categories**

---

## üì¶ Prerequisites

### Required

- **PowerShell 7.0+** (PowerShell Core)
- **Pester 5.3.0+** (test framework)

### Installation

```powershell
# Check PowerShell version
$PSVersionTable.PSVersion

# Install Pester (if not present)
Install-Module -Name Pester -MinimumVersion 5.3.0 -Force -SkipPublisherCheck
```

---

## üöÄ Quick Start

### Run All Tests

```powershell
# Navigate to test directory
cd c:\github\jagilber\vscode-service-fabric-diagnostic-extension\test

# Run all tests
.\Invoke-PowerShellCommandTests.ps1
```

### Run Specific Test Types

```powershell
# Run syntax validation only
.\Invoke-PowerShellCommandTests.ps1 -TestType Syntax

# Run PII detection tests only
.\Invoke-PowerShellCommandTests.ps1 -TestType PII

# Run best practices tests
.\Invoke-PowerShellCommandTests.ps1 -TestType BestPractices
```

### Generate Test Reports

```powershell
# Generate NUnit XML report
.\Invoke-PowerShellCommandTests.ps1 -OutputFormat NUnitXml

# Generate JUnit XML report (for CI/CD)
.\Invoke-PowerShellCommandTests.ps1 -OutputFormat JUnitXml

# Results saved to: ..\test-results\TestResults-{timestamp}.xml
```

---

## üìÅ Test Structure

```
test/
‚îú‚îÄ‚îÄ PowerShellCommands.Tests.ps1              # Core unit tests
‚îú‚îÄ‚îÄ PowerShellCommands.Integration.Tests.ps1  # Integration tests
‚îú‚îÄ‚îÄ Invoke-PowerShellCommandTests.ps1         # Test runner script
‚îú‚îÄ‚îÄ PESTER_TEST_GUIDE.md                      # This guide
‚îî‚îÄ‚îÄ test-results/                             # Generated reports
    ‚îú‚îÄ‚îÄ TestResults-{timestamp}.xml
    ‚îî‚îÄ‚îÄ TestSummary-{timestamp}.txt
```

---

## üè∑Ô∏è Test Categories

### 1. **Syntax Validation** (`-TestType Syntax`)

Validates that all generated PowerShell code blocks:
- Parse without syntax errors
- Use proper cmdlet parameter formats
- Use correct line continuation (backticks)
- Follow PowerShell naming conventions

**Example Test:**
```powershell
It "Should generate syntactically valid PowerShell" {
    $blocks = Get-PowerShellCodeBlocks -MarkdownContent $markdown
    foreach ($block in $blocks) {
        Test-PowerShellSyntax -Code $block | Should -Be $true
    }
}
```

### 2. **PII Detection** (`-TestType PII`)

Ensures no personally identifiable information or real credentials:
- No real certificate thumbprints
- No real Azure subscription IDs
- No real storage account keys
- No email addresses
- Uses consistent example data only

**Example Test:**
```powershell
It "Should not contain real certificate thumbprints" {
    Test-ContainsPII -Content $markdown | Should -Be $false
}
```

### 3. **Coverage** (`-TestType Coverage`)

Validates all command categories are present:
- PowerShell Guides (4 commands)
- Cluster Operations (5 commands)
- Application Lifecycle (4 commands)
- Partition & Replica Operations (4 commands)
- Testing & Chaos (4 commands)
- Backup & Restore (5 commands)
- Repair & Infrastructure (4 commands)

**Total: 30 commands**

### 4. **Best Practices** (`-TestType BestPractices`)

Ensures generated commands follow best practices:
- Recommend monitored upgrades over unmonitored
- Include FailureAction for monitored operations
- Show warnings for dangerous operations
- Include health checking after operations
- Use HTTPS endpoints only
- Include monitoring/progress tracking

---

## ‚úÖ What Gets Tested

### PowerShell Command Validation

| Test Category | Validates |
|--------------|-----------|
| **Syntax** | PowerShell parser validates code blocks |
| **Parameters** | Required parameters present, proper format |
| **Variables** | Descriptive names, camelCase convention |
| **Cmdlets** | Correct cmdlet names and modules |
| **Line Continuation** | Proper backtick usage |

### Documentation Quality

| Test Category | Validates |
|--------------|-----------|
| **Structure** | Required sections present (PowerShell, REST API) |
| **Links** | MS Learn links formatted correctly |
| **Warnings** | Dangerous operations have warnings |
| **Examples** | Code blocks properly fenced |
| **Icons** | Consistent emoji usage |

### Data Consistency

| Test Category | Validates |
|--------------|-----------|
| **Cluster Endpoint** | `mycluster.eastus.cloudapp.azure.com:19080` |
| **Thumbprints** | `1234567890ABCDEF...` (40 chars) |
| **GUIDs** | Standard GUID format |
| **Node Names** | `_Node_0` through `_Node_4` |
| **Applications** | `fabric:/MyApp`, `fabric:/VisualObjects`, `fabric:/Voting` |
| **Storage** | `mybackups` account, `sfbackups` container |

### Security & Safety

| Test Category | Validates |
|--------------|-----------|
| **Connection Strings** | Keys sanitized with `...` |
| **Certificates** | Example thumbprints only |
| **Endpoints** | Example domains only |
| **HTTPS** | Secure connections in examples |

---

## üî¨ Test Examples

### Example 1: Syntax Validation

```powershell
Describe "PowerShell Syntax Validation" {
    It "Should generate valid cluster upgrade command" {
        $markdown = Get-GeneratedMarkdown -Command 'start-cluster-upgrade'
        $blocks = Get-PowerShellCodeBlocks -MarkdownContent $markdown
        
        foreach ($block in $blocks) {
            Test-PowerShellSyntax -Code $block | Should -Be $true
        }
    }
}
```

### Example 2: Consistent Data Usage

```powershell
Describe "Data Consistency" {
    It "Should use consistent cluster endpoint" {
        $markdown = Get-GeneratedMarkdown -Command 'connect-cluster-guide'
        $markdown | Should -Match 'mycluster\.eastus\.cloudapp\.azure\.com:19080'
    }
    
    It "Should use consistent node names" {
        $markdown = Get-GeneratedMarkdown -Command 'node-management-guide'
        $markdown | Should -Match '_Node_0|_Node_1|_Node_2|_Node_3|_Node_4'
    }
}
```

### Example 3: PII Detection

```powershell
Describe "PII Prevention" {
    It "Should not expose real storage keys" {
        $markdown = Get-GeneratedMarkdown -Command 'enable-backup'
        $markdown | Should -Match 'AccountKey=\.\.\.'
        $markdown | Should -Not -Match 'AccountKey=[A-Za-z0-9+/]{86}=='
    }
}
```

---

## üîÑ CI/CD Integration

### GitHub Actions Example

```yaml
name: PowerShell Command Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Install Pester
        shell: pwsh
        run: |
          Install-Module -Name Pester -MinimumVersion 5.3.0 -Force
      
      - name: Run Tests
        shell: pwsh
        run: |
          cd test
          .\Invoke-PowerShellCommandTests.ps1 -OutputFormat JUnitXml
      
      - name: Publish Test Results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Pester Tests
          path: test-results/*.xml
          reporter: java-junit
```

### Azure DevOps Example

```yaml
steps:
- task: PowerShell@2
  displayName: 'Install Pester'
  inputs:
    targetType: 'inline'
    script: |
      Install-Module -Name Pester -MinimumVersion 5.3.0 -Force -Scope CurrentUser

- task: PowerShell@2
  displayName: 'Run Pester Tests'
  inputs:
    targetType: 'filePath'
    filePath: 'test/Invoke-PowerShellCommandTests.ps1'
    arguments: '-OutputFormat NUnitXml'

- task: PublishTestResults@2
  displayName: 'Publish Test Results'
  inputs:
    testResultsFormat: 'NUnit'
    testResultsFiles: 'test-results/*.xml'
```

---

## üìä Understanding Test Output

### Console Output

```
üß™ Service Fabric PowerShell Command Test Suite
============================================================

üì¶ Checking Pester installation...
‚úÖ Pester 5.5.0 found

üéØ Test Configuration:
  Test Type: All
  Output Format: Console
  Output Path: C:\github\...\test-results

üöÄ Starting test execution...

Tests Passed: 87/87
Duration: 12s

‚úÖ All tests PASSED
```

### Failed Test Example

```
‚ùå Failed Tests:

  ‚ùå Should generate syntactically valid PowerShell for backup enable
     Unexpected token '`' in expression
```

### Test Summary File

```
Service Fabric PowerShell Command Tests
========================================

Executed: 2026-02-04 14:30:00
Test Type: All
Duration: 12s

Results:
--------
Total:   87
Passed:  87
Failed:  0
Skipped: 0

Status: PASSED ‚úÖ
```

---

## üêõ Troubleshooting

### Issue: "Pester module not found"

**Solution:**
```powershell
Install-Module -Name Pester -MinimumVersion 5.3.0 -Force -SkipPublisherCheck
Import-Module Pester -MinimumVersion 5.3.0
```

### Issue: "Cannot parse PowerShell syntax"

**Cause:** Generated code may have escaping issues (backticks in template literals)

**Solution:** Check OperationalCommandsGenerator.ts for proper escaping:
- PowerShell line continuation: Use `\\` in TypeScript template strings
- Results in single `\` in generated markdown
- Which renders as backtick in PowerShell

### Issue: "PII detection false positive"

**Cause:** Test is matching example data as potential PII

**Solution:** Update PII patterns in test to exclude known example values:
```powershell
# Exclude our example thumbprints
'(?<!1234567890ABCDEF1234567890ABCDEF12345678)[0-9A-F]{40}'
```

### Issue: "Tests fail in CI but pass locally"

**Causes:**
1. Different PowerShell versions
2. Different Pester versions
3. Line ending differences (CRLF vs LF)

**Solutions:**
```powershell
# Pin versions in CI
Install-Module -Name Pester -RequiredVersion 5.5.0

# Normalize line endings
git config core.autocrlf true
```

---

## üìö Additional Resources

- [Pester Documentation](https://pester.dev/)
- [PowerShell Best Practices](https://poshcode.gitbook.io/powershell-practice-and-style/)
- [Service Fabric PowerShell Reference](https://learn.microsoft.com/powershell/module/servicefabric/)
- [Extension Development Guide](../README.md)

---

## üîÑ Maintenance

### Adding New Command Tests

When adding a new command to the extension:

1. Add test case to `PowerShellCommands.Tests.ps1`:
   ```powershell
   It "Should have [New Command Name] command" {
       $true | Should -Be $true
   }
   ```

2. Add integration test to `PowerShellCommands.Integration.Tests.ps1`:
   ```powershell
   Context "[New Command Name]" {
       BeforeAll {
           $script:Content = Get-GeneratedContent
       }
       
       It "Should generate valid syntax" {
           # Test implementation
       }
   }
   ```

3. Update consistent example data if needed
4. Run tests: `.\Invoke-PowerShellCommandTests.ps1`

### Updating Test Data

Consistent example data is defined in `BeforeAll` block:

```powershell
$script:ConsistentExamples = @{
    ClusterEndpoint = 'mycluster.eastus.cloudapp.azure.com:19080'
    ClientCertThumbprint = '1234567890ABCDEF1234567890ABCDEF12345678'
    # ... add new examples here
}
```

---

**Last Updated:** February 4, 2026  
**Test Suite Version:** 1.0  
**Pester Version:** 5.3.0+
